# ZipStore 数据管理系统使用说明

## 概述

系统已完成从硬编码数据到数据库驱动的全面升级，现在所有资源数据都存储在SQLite数据库中，支持通过后台管理界面进行完整的增删改查操作。

## 数据库结构

### 核心表

1. **categories** - 分类表
   - 管理所有资源分类（概念原画、3D模型、软件工具等）
   - 支持自定义meta_schema定义分类特有字段

2. **resources** - 资源主表
   - 存储所有资源的核心信息
   - 通过category_id关联分类
   - 通过author_id关联发布者
   - attributes字段存储JSON格式的扩展属性

3. **assets** - 文件资产表
   - 管理所有上传的文件
   - 记录文件大小用于空间统计
   - 支持封面图和资源文件

4. **users** - 用户表（已升级）
   - 新增role字段（admin/user）
   - 新增storage_used字段（已用空间统计）

## 功能特性

### 后台管理功能

1. **仪表盘** (`/admin`)
   - 统计卡片：总资源数、总用户数、总占用空间、今日新增
   - 空间占用排行榜：Top 10用户
   - 最近资源列表

2. **分类管理** (`/admin/categories`)
   - 添加/编辑/删除分类
   - 配置分类的meta_schema
   - 分类排序

3. **通用发布器** (`/admin/create`)
   - 动态表单：根据选择的分类自动显示对应字段
   - 文件上传：支持封面图和资源文件上传
   - 自动填充：作者、时间、统计数据自动初始化
   - 数据验证：根据meta_schema验证必填字段

4. **资源管理** (`/admin/resources`)
   - 列表展示：支持按分类、作者、状态筛选
   - 搜索功能：按标题和描述搜索
   - 编辑和删除功能

5. **用户管理** (`/admin/users`)
   - 用户列表：显示用户信息和统计数据
   - 用户详情：查看用户发布的资源和上传的文件
   - 空间统计：按用户统计空间占用

### 文件上传系统

- **上传路径**：`/admin/api/upload`
- **存储位置**：`public/uploads/YYYY/MM/`
- **支持格式**：图片（jpg/png/gif/webp）、压缩包（zip/rar/7z）、PDF
- **文件大小限制**：500MB
- **自动功能**：
  - 生成唯一文件名（UUID + 时间戳）
  - 自动计算文件大小
  - 更新用户空间使用量

### 自动统计功能

1. **浏览量统计**
   - 访问资源详情页时自动+1
   - 路由：`/home/view/:id`, `/design-assets/view/:id`, `/software/view/:id`

2. **下载量统计**
   - 通过下载API下载时自动+1
   - 路由：`/admin/api/download/:id`

3. **空间统计**
   - 上传文件时自动增加用户空间使用量
   - 删除文件时自动减少

## 前台模块改造

### 首页模块 (`/`)
- 从数据库读取最新资源
- 按分类分组显示
- 支持分类筛选

### 设计素材模块 (`/design-assets`)
- 从数据库读取设计素材资源
- 解析attributes JSON显示扩展属性
- 支持筛选和搜索

### 软件工具模块 (`/software`)
- 从数据库读取软件资源
- 显示版本历史（从attributes中解析）
- 自动更新浏览量

## 数据迁移

### 运行迁移脚本

将硬编码数据导入数据库：

```bash
node tools/migrate_data.js
```

迁移脚本会将以下数据导入：
- 首页示例数据（概念原画、3D模型、场景地编）
- 设计素材示例数据
- 软件工具示例数据

## 使用流程

### 发布新资源

1. 访问 `/admin/create`
2. 选择分类（系统会根据分类显示对应字段）
3. 填写基本信息（标题、描述等）
4. 上传封面图（点击上传区域）
5. 填写分类特有字段（如3D模型的面数、格式等）
6. 点击"立即发布"

### 管理资源

1. 访问 `/admin/resources`
2. 使用筛选功能查找资源
3. 点击"编辑"修改资源信息
4. 点击"删除"删除资源（会同时删除关联的文件）

### 管理分类

1. 访问 `/admin/categories`
2. 点击"添加分类"创建新分类
3. 配置meta_schema定义该分类需要的字段
4. 编辑或删除现有分类

## 注意事项

1. **文件管理**：删除资源时会自动删除关联的物理文件，请谨慎操作
2. **空间统计**：用户空间使用量会在上传/删除文件时自动更新
3. **数据备份**：定期备份 `data/jackyroom.db` 和 `public/uploads/` 目录
4. **分类配置**：meta_schema使用JSON格式，定义分类需要的额外字段

## 扩展属性示例

### 3D模型分类
```json
{
  "poly_count": "50k",
  "format": "FBX",
  "engine": "UE5",
  "software": "Blender"
}
```

### 软件工具分类
```json
{
  "version": "2024.1",
  "platform": "Windows / macOS",
  "license": "商业",
  "tutorial": "安装步骤...",
  "history_versions": [...]
}
```

### 概念原画分类
```json
{
  "resolution": "4K",
  "style": "Cyberpunk",
  "software": "Photoshop"
}
```

## 技术栈

- **数据库**：SQLite3
- **文件上传**：Multer
- **唯一ID生成**：UUID
- **数据格式**：JSON（用于扩展属性）

## 后续扩展建议

1. **搜索功能**：全文搜索资源标题和描述
2. **评论系统**：为资源添加评论功能
3. **收藏功能**：用户收藏资源
4. **API接口**：提供RESTful API供前端调用
5. **批量操作**：批量删除、批量审核等功能

